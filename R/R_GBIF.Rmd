---
title: "Get occurrences from GBIF"
output: html_document
---

------------------------------------------------------------------------

**GBIF** (Global Biodiversity Information Facility) is an international open-data infrastructure that provides free and open access to biodiversity data. It aggregates species occurrence records (e.g., observations, museum specimens, and monitoring data) from around the world, making them available for research, conservation, and policy-making. Although you can download data directly from the [GBIF website](https://www.gbif.org/), you can also retrieve occurrences programmatically using R. Let’s see how to do it.

First, the package that allows us to access GBIF data is [*rgbif*](https://www.gbif.org/tool/81747/rgbif). You’ll need to install it along with its required dependencies.

```{r, echo=T, warning=FALSE, message=FALSE, eval=FALSE}
install.packages("rgbif", dependencies = TRUE)
```

<br>

Now, with the package installed, you need to load the library and begin your search. For example, you can use the function <b>*occ_search()*</b>, which is the simplest and most straightforward option. In this example, you’ll download occurrences of <b>*Marmota monax*</b> (groundhog).

Since you’ll likely use spatial data for analysis, you’ll want only records with coordinates—GBIF also includes non-georeferenced records. To filter these, set the parameter <b>*hasCoordinate = TRUE*</b>.

```{r, warning=FALSE, eval=TRUE, echo=TRUE, include=TRUE}
library(rgbif)

occ_data <- occ_search(
  scientificName = "Marmota monax",
  hasCoordinate = TRUE  # Only records with coordinates
)
```

<br>

Now, let’s explore the results. The <b>occ_data</b> object is a structured list containing different types of data. An easy way to inspect its contents is using the <b>str()</b> function.

As you’ll see, <b>occ_data</b> consists of several components:

-   **meta**: Metadata about your query
-   **hierarchy**: Taxonomic classification details
-   **data**: The core occurrence records (as a tibble)
-   **media**: Associated multimedia information
-   **facets**: Aggregated statistics (if requested)

The **data** component contains all the key information - not just coordinates, but also year, date, taxonomy, observation type, and more.

```{r, warning=FALSE, eval=TRUE, echo=TRUE, include=TRUE}
str(occ_data, max.level = 1)
```

<br>

One limitation of the <b>\*occ_search()\*</b> function is its default return **limit** of 500 occurrence records. Fortunately, you can adjust this by specifying the limit parameter, and further refine your search using additional filters like year ranges, country codes, species specifications, and spatial precision requirements.

```{r, warning=F, eval=FALSE}
dim(occ_data$data) #Check the dimensions of the table

# Tuning Your GBIF Search Parameters

occ_data <- occ_search(
  scientificName = "Marmota monax",
  country = "US",  # Country code
  year = "2000,2023",  # Year range
  basisOfRecord = "HUMAN_OBSERVATION",  # Only human observations
  hasCoordinate = TRUE,
  limit=90000
)

dim(occ_data$data) #Check the dimensions of the table 

```
<br>

This function offers numerous parameters, allowing you to refine your
search with precision. To view all available options, simply run:

```{r, warning=F, message=FALSE, eval=FALSE}
?occ_search
```
<br>

Here is the final code with optimized parameters for this exercise. You can save your data in either CSV or RDS format - both are good options. If you need to work with the coordinates in other software, we recommend using the CSV format.

```{r, warning=FALSE, message=FALSE, eval=FALSE}
occ_data <- occ_search(
  scientificName = "Marmota monax",
  country = "US",  # Country code
  hasCoordinate = TRUE,
  limit=90000
)

dim(occ_data$data) #Check the dimensions of the table

# Save as CSV
write.csv(occ_data$data, "M_monax_gbif_occurrences.csv", row.names = FALSE)

# Save as RDS (preserves data types)
saveRDS(occ_data$data, "M_monax_gbif_occurrences.rds")

```

---

If you publish research using GBIF data, you must properly cite the datasets you used. While GBIF provides ready-made citations when downloading data through their website, downloading data directly from R requires additional steps and a different function. Below, we’ll walk through the complete process for proper attribution.

First, you'll need a GBIF account and set up in the R the account, password and email associated with that account.

```{r, eval=F}
usethis::edit_r_environ()

## Add these lines

GBIF_USER="your_username"
GBIF_PWD="your_password"
GBIF_EMAIL="your_email"

```
<br>

In GBIF, each taxon has a specific indentifier known as a *Taxon Key*. To find it, run this line:

```{r, eval=F}
key <- name_backbone(name = "Marmota monax")$usageKey
```

